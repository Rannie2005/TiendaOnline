{% extends 'base.html' %}
{% load static %}

{% block title %}Pagar Carrito{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">ðŸ’³ Pago de tu carrito</h2>

    <ul class="list-group mb-3">
        {% for item in items %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ item.articulo.articulo.nombre }} ({{ item.articulo.color }} - {{ item.articulo.talla }})
                <span>RD$ {{ item.subtotal }}</span>
            </li>
        {% endfor %}
        <li class="list-group-item d-flex justify-content-between align-items-center fw-bold">
            Total
            <span>RD$ {{ total }}</span>
        </li>
    </ul>

    <form id="payment-form">
        <div id="card-element"></div>
        <button id="submit" class="btn btn-dark btn-lg mt-3">Pagar</button>
        <div id="payment-message" class="mt-3 text-danger"></div>
    </form>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe('{{ stripe_public_key }}');
const elements = stripe.elements();
const card = elements.create('card');
card.mount('#card-element');

const form = document.getElementById('payment-form');
const paymentMessage = document.getElementById('payment-message');

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const {error, paymentIntent} = await stripe.confirmCardPayment(
        '{{ client_secret }}',
        {payment_method: {card: card}}
    );

    if (error) {
        paymentMessage.textContent = error.message;
    } else if (paymentIntent.status === 'succeeded') {
        window.location.href = "{% url 'pago_exitoso' %}";
    } else {
        window.location.href = "{% url 'pago_fallido' %}";
    }
});
</script>
{% endblock %}
